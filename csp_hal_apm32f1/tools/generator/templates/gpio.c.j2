{#
 # Licensed under the Apache License v. 2 (the "License")
 # You may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
 #
 #     https://www.apache.org/licenses/LICENSE-2.0.html
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 #
 # Copyright (C) 2022-2024 xqyjlj<xqyjlj@126.com>
 #
 # @author      xqyjlj
 # @file        gpio.c.j2
 #
 # Change Logs:
 # Date           Author       Notes
 # ------------   ----------   -----------------------------------------------
 # 2024-03-22     xqyjlj       initial version
 #
 #}
{%- extends "csp-file-base.c.j2" %}

{%- set used_channels = CSP.project|gpio_channels() %}
{%- set used_ports = used_channels|gpio_used_ports() %}
{%- set eint_channels = CSP.project|gpio_eint_channels(used_channels) %}
{%- set eventout_channels = CSP.project|gpio_eventout_channels(used_channels) %}
{%- set eventout_eint_channels = eint_channels + eventout_channels %}

{%- block includes %}
#include "csp/gpio.h"
{%- endblock %}

{%- block function_body %}
void csp_gpio_init(void)
{
{%- if used_ports|length() > 0 %}
    GPIO_Config_T gpio_config = {0};
{%- endif %}
{%- if eint_channels|length() > 0 %}
    EINT_Config_T eint_config = {0};
{%- endif %}
{#  #}
{%- set clocks = CSP.project|gpio_used_clocks() %}
{%- if clocks|length() > 0 %}
    /*!< enable the {{ clocks|gpio_clocks_to_alias|join(", ") }} clock. */
    RCM_EnableAPB2PeriphClock({{ clocks|join(" | ") }});
{%- endif %}

{%- for port in used_ports %}
    {%- for channels_group in CSP.project|gpio_channels_group_by_port(used_channels, port) %}
{#  #}
    /**************************************************************************/
    {%- set pins = channels_group|gpio_channels_to_pins() %}
    /*!< configure the {{ port }}<{{ pins|join(", ") }}>. */

        {%- set channels_classified = CSP.project|gpio_channels_classify_by_state(channels_group) %}
        {%- if channels_classified %}
            {%- for level, channels in channels_classified.items() %}
            {%- set pins_classified = channels|gpio_channels_to_pins() %}
    GPIO_WriteBitValue({{ port }}, {{ pins_classified|join(" | ") }}, {{ level }});
            {%- endfor %}
        {%- endif %}

    gpio_config.pin = {{ pins|join(" | ") }};
    gpio_config.mode = {{ CSP.project|gpio_channel_mode(channels_group[0]) }};

        {%- set speed = CSP.project|gpio_channel_speed(channels_group[0]) %}
        {%- if speed %}
    gpio_config.speed = {{ speed }};
        {%- endif %}
    GPIO_Config({{ port }}, &gpio_config);
    {%- endfor %}
{%- endfor %}

{%- if eint_channels|length > 0 %}
    {%- for channel in eint_channels %}
{#  #}
    /**************************************************************************/
        {%- set port = channel|gpio_channel_to_port() %}
        {%- set pin = channel|gpio_channel_to_pin() %}
        {%- set port_source = channel|gpio_channel_to_port_source() %}
        {%- set pin_source = channel|gpio_channel_to_pin_source() %}
        {%- set eint_line = channel|gpio_channel_to_eint_line() %}
    /*!< selects the {{ port }}<{{ pin }}> used as eint. */
    GPIO_ConfigEINTLine({{ port_source }}, {{ pin_source }});

    eint_config.line = {{ eint_line }};
    eint_config.mode = {{ CSP.project|gpio_channel_eint_mode(channel) }};
    eint_config.trigger = {{ CSP.project|gpio_channel_eint_trigger(channel) }};
    eint_config.lineCmd = ENABLE;
    EINT_Config(&eint_config);

    // TODO: NVIC
    {%- endfor %}
{%- endif %}

{%- if eventout_channels|length > 0 %}
    {%- for channel in eventout_channels %}
{#  #}
    /**************************************************************************/
        {%- set port = channel|gpio_channel_to_port() %}
        {%- set pin = channel|gpio_channel_to_pin() %}
        {%- set port_source = channel|gpio_channel_to_port_source() %}
        {%- set pin_source = channel|gpio_channel_to_pin_source() %}
    /*!< selects the {{ port }}<{{ pin }}> used as event output. */
    GPIO_ConfigEventOutput({{ port_source }}, {{ pin_source }});
    {%- endfor %}

    /**************************************************************************/
    /*!< enables the event output. */
    GPIO_EnableEventOutput();
{%- endif %}
}
{%- endblock %}
