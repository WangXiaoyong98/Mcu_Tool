{#
 # Licensed under the Apache License v. 2 (the "License")
 # You may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
 #
 #     https://www.apache.org/licenses/LICENSE-2.0.html
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 #
 # Copyright (C) 2022-2024 xqyjlj<xqyjlj@126.com>
 #
 # @author      xqyjlj
 # @file        CMakeLists.txt.j2
 #
 # Change Logs:
 # Date           Author       Notes
 # ------------   ----------   -----------------------------------------------
 # 2024-03-22     xqyjlj       initial version
 # 2025-10-10     xqyjlj       improve cmake configuration
 #
 #}
{%- extends "csp-file-base.cmake.j2" %}

{%- block project_settings %}
set(CMAKE_SYSTEM_NAME Generic)
set(CMAKE_SYSTEM_PROCESSOR arm)
set(CMAKE_SYSTEM_VERSION 1)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_COLOR_DIAGNOSTICS ON)

set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_C_EXTENSIONS OFF)
set(CMAKE_CXX_STANDARD 11)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

if(NOT CMAKE_BUILD_TYPE)
  set(CMAKE_BUILD_TYPE "Debug" CACHE STRING "Build type (Debug, Release, RelWithDebInfo, MinSizeRel)" FORCE)
  set_property(CACHE CMAKE_BUILD_TYPE PROPERTY STRINGS "Debug" "Release" "RelWithDebInfo" "MinSizeRel")
endif()
{%- endblock %}

{%- block toolchains %}
set(CMAKE_C_COMPILER_FORCED   TRUE)
set(CMAKE_CXX_COMPILER_FORCED TRUE)
set(CMAKE_C_COMPILER_ID       GNU)
set(CMAKE_CXX_COMPILER_ID     GNU)

set(TOOLCHAINS_PATH $ENV{CSP_TOOLCHAIN_PATH})
if(NOT TOOLCHAINS_PATH)
  {%- if CSP.toolchainsPath %}
  set(TOOLCHAINS_PATH "{{ CSP.toolchainsPath }}/bin/")
  {%- else %}
  set(TOOLCHAINS_PATH "")
  {%- endif %}
endif()

if(WIN32)
  set(EXECUTABLE_SUFFIX ".exe")
endif()

set(CMAKE_C_COMPILER    ${TOOLCHAINS_PATH}arm-none-eabi-gcc${EXECUTABLE_SUFFIX})
set(CMAKE_ASM_COMPILER  ${TOOLCHAINS_PATH}arm-none-eabi-gcc${EXECUTABLE_SUFFIX})
set(CMAKE_CXX_COMPILER  ${TOOLCHAINS_PATH}arm-none-eabi-g++${EXECUTABLE_SUFFIX})
set(CMAKE_OBJCOPY       ${TOOLCHAINS_PATH}arm-none-eabi-objcopy${EXECUTABLE_SUFFIX})
set(CMAKE_OBJDUMP       ${TOOLCHAINS_PATH}arm-none-eabi-objdump${EXECUTABLE_SUFFIX})
set(CMAKE_SIZE          ${TOOLCHAINS_PATH}arm-none-eabi-size${EXECUTABLE_SUFFIX})
{%- endblock %}

{%- block project_info %}
project({{ CSP.project.name }} VERSION 0.0.0 LANGUAGES ASM C)
{%- endblock %}

{%- block flags %}
set(COMMON_FLAGS
  -mcpu=cortex-m3
  -mthumb
  -mthumb-interwork
  -ffunction-sections
  -fdata-sections
  -fno-common
  -fmessage-length=0
  -Wall
)

set(LINKER_SCRIPT ${CMAKE_SOURCE_DIR}/{{ CSP.project.targetChip }}.lds)

add_compile_definitions(
{%- for define in CSP.project|builder_defines  %}
  {{ define }}
{%- endfor %}
)

if("${CMAKE_BUILD_TYPE}" STREQUAL "Release")
  message(STATUS "Build type: Release (maximum optimization for speed)")
  set(OPTIMIZATION_FLAGS -Ofast)
elseif("${CMAKE_BUILD_TYPE}" STREQUAL "RelWithDebInfo")
  message(STATUS "Build type: RelWithDebInfo (maximum optimization for speed with debug info)")
  set(OPTIMIZATION_FLAGS -Ofast -g)
elseif("${CMAKE_BUILD_TYPE}" STREQUAL "MinSizeRel")
  message(STATUS "Build type: MinSizeRel (maximum optimization for size)")
  set(OPTIMIZATION_FLAGS -Os)
else()
  message(STATUS "Build type: Debug (minimal optimization with debug info)")
  set(OPTIMIZATION_FLAGS -Og -g)
endif()
{%- endblock %}

{%- block files %}
set(SOURCES
{%- for file in CSP.project|builder_src_files %}
  {{ file }}
{%- endfor %}
{# #}
{%- if CSP.project.gen.toolchains == "gcc-arm-none-eabi" %}
  startup_gcc.S
{%- endif %}
)
{%- endblock %}

{%- block includes %}
set(INCLUDES
{%- for dir in CSP.project|builder_inc_dirs %}
    {{ dir }}
{%- endfor %}
)
{%- endblock %}

{%- block executable %}
add_executable(${PROJECT_NAME}.elf ${SOURCES} ${LINKER_SCRIPT})

target_include_directories(${PROJECT_NAME}.elf PRIVATE ${INCLUDES})

target_compile_options(${PROJECT_NAME}.elf PRIVATE
  ${COMMON_FLAGS}
  ${OPTIMIZATION_FLAGS}
  $<$<COMPILE_LANGUAGE:ASM>:-x assembler-with-cpp>
)

target_link_options(${PROJECT_NAME}.elf PRIVATE
  ${COMMON_FLAGS}
  -specs=nano.specs
  -specs=nosys.specs
  -Wl,--gc-sections
  -Wl,--print-memory-usage
  -Wl,-Map=${PROJECT_BINARY_DIR}/${PROJECT_NAME}.map
  -Wl,--cref
  -T${LINKER_SCRIPT}
)

set_target_properties(${PROJECT_NAME}.elf PROPERTIES LINK_DEPENDS ${LINKER_SCRIPT})
{%- endblock %}

{%- block command %}
add_custom_command(TARGET ${PROJECT_NAME}.elf POST_BUILD
  COMMAND ${CMAKE_OBJCOPY} -O binary $<TARGET_FILE:${PROJECT_NAME}.elf> ${PROJECT_BINARY_DIR}/${PROJECT_NAME}.bin
  COMMAND ${CMAKE_OBJCOPY} -O ihex $<TARGET_FILE:${PROJECT_NAME}.elf> ${PROJECT_BINARY_DIR}/${PROJECT_NAME}.hex
  COMMAND ${CMAKE_SIZE} --format=berkeley $<TARGET_FILE:${PROJECT_NAME}.elf>
  COMMENT "Generating binary and hex files, displaying memory usage"
  VERBATIM
)
{%- endblock %}
